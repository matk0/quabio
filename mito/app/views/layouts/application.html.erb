<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Miťo - Slovenský Zdravotný Asistent" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body class="h-full bg-gray-50">
    <!-- Top Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200 fixed top-0 left-0 right-0 z-50">
      <div class="mx-auto max-w-screen-xl px-4 sm:px-6 lg:px-8">
        <div class="flex h-16 items-center justify-between">
          <!-- Logo -->
          <div class="flex-1 md:flex md:items-center md:gap-12">
            <%= link_to root_path, class: "block text-emerald-600 transition hover:text-emerald-700" do %>
              <span class="sr-only">Home</span>
              <div class="flex items-center gap-2">
                <span class="text-2xl">🧬</span>
                <span class="text-xl font-bold">Miťo</span>
              </div>
            <% end %>
          </div>

          <div class="md:flex md:items-center md:gap-12">
            <% if user_signed_in? %>
              <!-- Authenticated Navigation -->
              <nav aria-label="Global" class="hidden md:block">
                <ul class="flex items-center gap-6 text-sm">
                  <li>
                    <%= link_to chats_path, 
                        class: "text-gray-500 transition hover:text-gray-500/75" do %>
                      Konverzácie
                    <% end %>
                  </li>
                </ul>
              </nav>

              <!-- User Menu -->
              <div class="flex items-center gap-4">
                <div class="relative" data-controller="dropdown">
                  <div class="inline-flex items-center overflow-hidden rounded-md border bg-white">
                    <button 
                      data-action="click->dropdown#toggle"
                      class="border-e px-4 py-2 text-sm/none text-gray-600 hover:bg-gray-50 hover:text-gray-700"
                    >
                      <div class="flex items-center gap-2">
                        <div class="h-8 w-8 rounded-full bg-emerald-100 flex items-center justify-center">
                          <span class="text-sm font-medium text-emerald-700">
                            <%= current_user.email.first.upcase %>
                          </span>
                        </div>
                        <span class="hidden sm:block text-sm font-medium text-gray-900">
                          <%= current_user.email.split('@').first %>
                        </span>
                      </div>
                    </button>

                    <button 
                      data-action="click->dropdown#toggle"
                      class="h-full p-2 text-gray-600 hover:bg-gray-50 hover:text-gray-700"
                    >
                      <span class="sr-only">Menu</span>
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                          clip-rule="evenodd"
                        />
                      </svg>
                    </button>
                  </div>

                  <div
                    data-dropdown-target="menu"
                    class="absolute end-0 z-10 mt-2 w-56 divide-y divide-gray-100 rounded-md border border-gray-100 bg-white shadow-lg hidden"
                    role="menu"
                  >
                    <div class="p-2">
                      <div class="block rounded-lg px-4 py-2 text-sm text-gray-500">
                        <div class="font-medium"><%= current_user.email %></div>
                        <div class="text-xs text-gray-400">
                          <%= current_user.admin? ? 'Administrator' : 'Používateľ' %>
                        </div>
                      </div>
                    </div>

                    <% if current_user.admin? %>
                      <div class="p-2">
                        <%= link_to admin_dashboard_path, class: "flex w-full items-center gap-2 rounded-lg px-4 py-2 text-sm text-gray-700 hover:bg-gray-50" do %>
                          📊 Admin Dashboard
                        <% end %>
                        <%= link_to sources_path, class: "flex w-full items-center gap-2 rounded-lg px-4 py-2 text-sm text-gray-700 hover:bg-gray-50" do %>
                          📚 Správa zdrojov
                        <% end %>
                      </div>
                    <% end %>

                    <div class="p-2">
                      <%= form_with url: destroy_user_session_path, method: :delete, local: true, class: "block" do |form| %>
                        <%= form.submit "Odhlásiť sa", 
                            class: "flex w-full items-center gap-2 rounded-lg px-4 py-2 text-sm text-red-700 hover:bg-red-50 cursor-pointer border-0 bg-transparent" %>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            <% else %>
              <!-- Anonymous Navigation -->
              <div class="flex items-center gap-4">
                <div class="sm:flex sm:gap-4">
                  <%= link_to new_user_session_path, 
                      class: "rounded-md bg-emerald-600 px-5 py-2.5 text-sm font-medium text-white shadow transition hover:bg-emerald-700" do %>
                    Prihlásiť sa
                  <% end %>

                  <div class="hidden sm:flex">
                    <%= link_to new_user_registration_path, 
                        class: "rounded-md bg-gray-100 px-5 py-2.5 text-sm font-medium text-emerald-600 transition hover:text-emerald-600/75" do %>
                      Registrovať sa
                    <% end %>
                  </div>
                </div>

                <!-- Mobile menu button for anonymous users -->
                <div class="block md:hidden">
                  <button class="rounded bg-gray-100 p-2 text-gray-600 transition hover:text-gray-600/75">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-5 w-5"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                  </button>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </nav>

    <!-- Flash Messages Container -->
    <div id="flash-messages" class="fixed top-20 right-4 z-50 space-y-2 w-80">
      <% if notice %>
        <%= render 'shared/flash_alert', message: notice, type: 'notice' %>
      <% end %>
      
      <% if alert %>
        <%= render 'shared/flash_alert', message: alert, type: 'alert' %>
      <% end %>
    </div>

    <!-- Main Content -->
    <main class="pt-16 h-screen">
      <%= yield %>
    </main>
  </body>
</html>

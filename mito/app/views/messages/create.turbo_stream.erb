<!-- Append user message -->
<%= turbo_stream.append "messages" do %>
  <%= render 'messages/message', message: @message %>
<% end %>

<!-- Append assistant message if present -->
<% if @assistant_message %>
  <%= turbo_stream.append "messages" do %>
    <%= render 'messages/message', message: @assistant_message %>
  <% end %>
<% end %>

<!-- Show signup invitation after first assistant response (for anonymous users) -->
<% if defined?(@show_signup_invitation) && @show_signup_invitation %>
  <%= turbo_stream.append "messages" do %>
    <div class="flex justify-center my-6" id="signup_invitation">
      <div class="max-w-md bg-gradient-to-r from-emerald-50 to-emerald-100 border border-emerald-200 rounded-lg p-4 shadow-sm">
        <div class="text-center">
          <div class="text-2xl mb-2">✨</div>
          <h3 class="text-lg font-semibold text-emerald-800 mb-2">Páči sa vám Miťo?</h3>
          <p class="text-sm text-emerald-700 mb-4">
            Zaregistrujte sa a uložte si históriu konverzácií, aby ste sa k nim mohli vrátiť kedykoľvek.
          </p>
          <div class="flex space-x-2 justify-center">
            <%= link_to new_user_registration_path, 
                class: "bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors" do %>
              Registrovať sa
            <% end %>
            <%= link_to new_user_session_path, 
                class: "bg-white hover:bg-gray-50 text-emerald-600 border border-emerald-600 px-4 py-2 rounded-md text-sm font-medium transition-colors" do %>
              Prihlásiť sa
            <% end %>
          </div>
          <p class="text-xs text-emerald-600 mt-2">
            Môžete pokračovať aj bez registrácie
          </p>
        </div>
      </div>
    </div>
  <% end %>
<% end %>

<!-- Reset the form -->
<%= turbo_stream.update "new_message" do %>
  <% if user_signed_in? %>
    <%= form_with model: [@chat, Message.new], local: false, id: "new_message" do |form| %>
      <div class="flex space-x-3">
        <div class="flex-1">
          <%= form.text_area :content, 
              class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 resize-none",
              rows: 2,
              placeholder: "Napíšte svoju otázku o zdraví...",
              required: true %>
        </div>
        <div class="flex items-stretch">
          <%= form.submit "Odoslať", 
              class: "bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md font-medium focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 h-full flex items-center" %>
        </div>
      </div>
    <% end %>
  <% else %>
    <%= form_with model: AnonymousMessage.new, url: anonymous_messages_path, local: false, id: "new_message" do |form| %>
      <div class="flex space-x-3">
        <div class="flex-1">
          <%= form.text_area :content, 
              class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 resize-none",
              rows: 2,
              placeholder: "Napíšte svoju otázku o zdraví...",
              required: true %>
        </div>
        <div class="flex items-stretch">
          <%= form.submit "Odoslať", 
              class: "bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md font-medium focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 h-full flex items-center" %>
        </div>
      </div>
    <% end %>
  <% end %>
<% end %>

<!-- Auto-scroll to bottom -->
<%= turbo_stream.append "messages" do %>
  <script>
    setTimeout(function() {
      const container = document.getElementById('messages-container');
      if (container) {
        container.scrollTop = container.scrollHeight;
      }
    }, 100);
  </script>
<% end %>